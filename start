#!/bin/sh
# Agentation â€” Run OpenCode with MCP server
# Usage: ./start

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Allow override via environment variable
OPENCODE_BINARY="${XOPENCODE_BINARY:-}"

# Auto-detect: check common locations
if [ -z "$OPENCODE_BINARY" ]; then
  # Check if xoc is installed and can resolve the binary
  if command -v xoc >/dev/null 2>&1; then
    OPENCODE_BINARY="$(xoc which 2>/dev/null || true)"
  fi
fi

if [ -z "$OPENCODE_BINARY" ]; then
  # Check sibling xoc project
  XOC_BINARY_PATH="$(dirname "$SCRIPT_DIR")/xoc/packages/opencode/dist/opencode-$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m | sed 's/x86_64/x64/' | sed 's/aarch64/arm64/')/bin/opencode"
  if [ -f "$XOC_BINARY_PATH" ]; then
    OPENCODE_BINARY="$XOC_BINARY_PATH"
  fi
fi

if [ -z "$OPENCODE_BINARY" ]; then
  echo "Error: OpenCode binary not found."
  echo ""
  echo "Options:"
  echo "  1. Install xoc: git clone https://github.com/GutMutCode/xoc && cd xoc && bun install && cd packages/opencode && bun run build"  
  echo "  2. Set XOPENCODE_BINARY environment variable to your opencode binary path"
  echo "  3. Place xoc project next to this project (../xoc/)"
  exit 1
fi

cd "$SCRIPT_DIR"
exec "$OPENCODE_BINARY"
